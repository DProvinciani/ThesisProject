#include "helpers.h"
#include "dispatcher.h"

#pragma comment(lib, "Ws2_32.lib")

DWORD WINAPI PtExploitDetectorAgentCore::RunPtExploitDetectorAgent(LPVOID lpParameter)
{
	bool ret = false;
	HANDLE coreThread = INVALID_HANDLE_VALUE;
	WORD wVersionRequested = MAKEWORD(1, 0);
	WSADATA wsaData;
	WSAStartup(wVersionRequested, &wsaData);
	srand(GetTickCount());

	DWORD currentPID = GetCurrentProcessId();
	std::wstring serverName(PtExploitDetectorCommon::PRE_CHANNEL_TOKEN + std::to_wstring(currentPID));

	dipc::server ptExploitDetectorAgentServer(serverName);
	ptExploitDetectorAgentServer.route(PtExploitDetectorCommon::ExecutorsMode::GET_REMOTE_FUNCTION_ADDRESS, PtExploitDetectorExecutors::GetRemoteFunctionAddress);

	ptExploitDetectorAgentServer.run();

	return ret;
}